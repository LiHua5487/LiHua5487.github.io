
# Linear Interpolation

考虑一维情况，假设有两个值 $u_0$ 和 $u_1$ ，要在两个值之间插入一个值，可以设定一个参数 $t\in [0,1]$ ，对两个值进行线性组合，这就是线性插值，公式如下

$$lerp(t)=(1-t)u_0+tu_1$$

把前面的系数视为一个权重，可以画图表示随着 $t$ 的增加，二者权重的变化

![[VCL/img/img2/image.png]]

线性插值可以用在绘制两点间的线段上，假设有一系列点，取其中相邻的两点 $(x_i,y_i)$ 和 $(x_{i+1},y_{i+1})$ ，可以通过以下公式计算两点间 $x$ 处对应的 $y$ 值

$$y(x) = \frac{x_{i+1} - x}{x_{i+1} - x_i}y_i + \frac{x - x_i}{x_{i+1} - x_i}y_{i+1}$$

两点权重的变化图像如下，在 $[x_i,x_{i+1}]$ 内，是两个直角三角形，类似地，可以得到 $(x_i,y_i)$ 这个点在 $[x_{i-1},x_i]$ 内的权重变化，可见每个点的权重变化是一个以该点为顶点的三角形

![[VCL/img/img2/image-1.png]]

可以将 $(x_i,y_i)$ 的权重变化表示为以下分段函数，这种决定每个点的权重的函数就被称为 **基函数 Basis Function**

$$B_i(x) =\begin{cases}\frac{x - x_{i-1}}{x_i - x_{i-1}}, & x \in [x_{i-1}, x_i] \\\frac{x_{i+1} - x}{x_{i+1} - x_i}, & x \in [x_i, x_{i+1}] \\0, & \text{else}\end{cases}$$

对于上面的插值公式，就可以表示成

$$y(x) = B_i(x)\cdot y_i + B_{i+1}(x)\cdot y_{i+1}$$

不同的插值方法可以对应到不同的基函数的选择，但是为了使得插值的结果经过所有数据点，基函数需要满足以下性质，称为 **插值性**

$$
B_i(x_j) = \delta_{ij} = 
\begin{cases} 
1, & i = j \\ 
0, & i \neq j 
\end{cases}
$$

# Bezier Curve

贝塞尔曲线可以通过一系列线性插值得到，下图展示了 2 阶和 3 阶贝塞尔曲线的绘制过程，可见这是一个递归的过程（3 阶先在每段插值得到 3 个控制点，这就变成了 2 阶曲线的绘制）

![[VCL/img/img2/image-2.png]]

>贝塞尔曲线虽通过插值得到，但并不是插值曲线（要求曲线经过每个控制点）

上述递归绘制贝塞尔曲线的算法就叫 **德卡斯特里奥 De Casteljau Algorithm**

我们也可以直接计算贝塞尔曲线的参数表达式，以 2 阶为例，先在两个线段插值得到两点 $a_0$ 和 $a_1$ 

$$
\begin{align}
a_0 &= (1 - t)u_0 + tc_0 \\
a_1 &= (1 - t)c_0 + tu_1 
\end{align}
$$

而后在这两点之间插值

$$b = (1 - t)a_0 + ta_1 = (1 - t)^2u_0 + 2t(1 - t)c_0 + t^2u_1$$

![[VCL/img/img2/image-3.png]]

对于更高阶的曲线，这个分叉树可以一直延展下去

![[VCL/img/img2/image-4.png]]

可以发现，每一列的含 $t$ 多项式前面的常数系数正好构成杨辉三角，可以将 n 阶贝塞尔曲线表述成以下形式

$$
b(t) = \sum_{k=0}^n \binom{n}{k} t^k (1 - t)^{n-k}u_k 
$$

>其中系数项 $B_{n,k}(t)=\binom{n}{k} t^k (1 - t)^{n-k}$ 被称为 n 阶伯恩斯坦多项式 Bernstein polynomials

也可以变成矩阵形式

![[VCL/img/img2/image-5.png]]

进一步推广，绘制贝塞尔曲面

![[VCL/img/img2/image-6.png]]

---

但是贝塞尔曲线有一个问题，就是只调整一个控制点，整个曲线都会跟着变化，但我们希望只改变控制点附近一段区间内的曲线，为此可以将一个高阶的贝塞尔曲线分为多段低阶的贝塞尔曲线表示，称为 **贝塞尔样条**

>**非局部性** ：改变一个控制点，整个曲线都会跟着变
>非全局 non-global ：改变一个控制点，只影响一段曲线，更容易调整

![[VCL/img/img2/image-7.png]]

>这里的"低阶"一般是 3 阶，能够保证多段曲线连接点处是 $C^1$ 的（2 阶保证不了，更高阶更难控制）

---

贝塞尔曲线另一个性质是 **凸包性 convex-hull property** ，即我们把一个贝塞尔曲线的控制点依次连接形成多边形，这个多边形会包裹住这条贝塞尔曲线（尽管不一定是最小的包围框）

![[VCL/img/img2/image-8.png]]

这个性质在规划路径方面很有用，比如在规划虚拟场景中相机的轨迹时，我们可以通过计算并调整控制点的凸包，避免相机走到我们不想到达的位置

# Spline Curve

样条曲线是一种分段曲线，每一段都可以用一个多项式表示，同时保证在连接点处具有一定的连续性（一般是 $C^2$ 连续）

>Spline 一词最初来源于工程和造船业使用的样条，即一种有弹性的木条或钢条，工程师们用重物（压铁）将样条压在多个点上，使其弯曲成所需的形状，样条会自然形成一条非常光滑的曲线，数学家们从中获得灵感，用分段的多项式函数来模拟这种物理样条的形态，从而诞生了数学上的样条曲线

常见的种类有插值样条（曲线经过每个控制点），逼近样条（曲线被控制点吸引但不经过）
## Interpolating Spline

假设有一系列控制点 $P_0, P_1, \dots, P_m$，其中每个点的坐标为 $P_i = (x_i, y_i)$ ，需要求解出每一段的曲线多项式，使得在连接点连续，假设我们每一段都用 3 次曲线（Cubic Spline）来表示，其参数化如下

$$
\begin{align}
x = f_i(t) = a_i t^3 + b_i t^2 + c_i t + d_i \\
y = g_i(t) = e_i t^3 + f_i t^2 + g_i t + h_i
\end{align}
$$

这里一共 8 个参数需要确定，$x$ 和 $y$ 各 4 个，下面以 $x$ 为例，一共有 m 段曲线（点下标是从 0 到 m），所以共有 4m 个参数，需要 4m 个方程
- 每段曲线要经过两个端点：共 2m 个方程
- 两段曲线的连接点处一阶导和二阶导分别相等：共 2(m-1) 个方程
- 还差 2 个方程，这可以自行指定，比如规定整条曲线两端二阶导为 0 

由上可见，三次样条具有 $C^2$ 连续，并且是插值曲线，但如果移动了某个控制点，就需要重新解方程，这会影响整个曲线的形状

### Hermite Spline

为了改进以上缺点，厄米特样条只要求 $C^1$ 连续，但可以手动指定每个控制点处的一阶导数值

假设我们指定点 $P_i$ 上的 $x$ 和 $y$ 参数方程的导数为 $p_i$ 和 $q_i$，以 $x$ 为例，对于 $(P_i, P_{i+1})$ 之间的函数，可以列出下面方程

$$
f_i(0) = x_i, \quad f_i(1) = x_{i+1}, \quad f_i'(0) = p_i, \quad f_i'(1) = p_{i+1}
$$

可以求解出参数方程

$$
f_i(t) = \underbrace{(2t^3 - 3t^2 + 1)}_{h_{00}(t)}x_i + \underbrace{(t^3 - 2t^2 + t)}_{h_{10}(t)}p_i + \underbrace{(-2t^3 + 3t^2)}_{h_{01}(t)}x_{i+1} + \underbrace{(t^3 - t^2)}_{h_{11}(t)}p_{i+1}
$$

这个中标记出的四个多项式称为 **厄米特基函数 Hermite basis functions**

上述一阶导数值也可以设置公式进行计算得到，比如设为 $p_i=\frac{1}{2}(x_{i+1}-x_i)$

## B-Spline Curve

厄米特曲线虽然是分段低阶、非全局 Non-global 的，但需要手动设置导数，而且只能达到 $C^1$ ，B 样条曲线在分段低阶、非全局的基础上，只需要调整控制点位置，而且能达到更高阶的连续（但 B 样条并不是插值曲线）

给定一系列控制点，一个 n 阶 B 样条曲线的公式如下

$$
b(t) = \sum_{i=0}^{m} N_{i,n}(t) \mathbf{P}_i
$$

这里的 $N_{i,n}(t)$ 就是 n 阶 B 样条基函数，回顾一下线性插值里的基函数，其与 1 阶 B 样条基函数相同，而 0 阶的基函数长得类似一个直方图

$$
N_{i, 0}(t) = \begin{cases} 1 & \text{if } t_i \leq t < t_{i+1} \\ 0 & \text{otherwise} \end{cases}
$$

我们可以采取线性插值的公式对基函数进行迭代，就能得到更加平滑的基函数，这被称为  **Cox–de Boor 递归**

$$
N_{i, p}(t) = \frac{t - t_i}{t_{i+p} - t_i} N_{i, p-1}(t) + \frac{t_{i+p+1} - t}{t_{i+p+1} - t_{i+1}} N_{i+1, p-1}(t)
$$

其满足性质

$$
\sum_{i=0}^{m} N_{i,p}(t) = 1, \quad \forall t \in [0, 1]
$$

![[VCL/img/img2/image-9.png]]

- $N_{i,p}(t)$ 是 p 阶的基函数，保证 $C^{p-1}$ 连续（0 阶 B 样条就是一堆点，1 阶 B 样条就是一堆折线段）
- $N_{i,p}(t)$ 不能保证在节点 $i$ 上取 1，在其他节点取 0，因此不满足插值性
- $N_{i,p}(t)$ 会影响到附近连续 $p+1$ 个区间内的值，因此 $p$ 越大基函数影响的范围越大，局部性就越差

B 样条的一个很大优势在于它的灵活性，比如可以在每一段选择不同阶数的基函数来满足不同的连续性的要求；还可以重复选择节点（ $t_i = t_{i+1} = \cdots = t_{i_k-1}$ ）表示这是一个重复度为 $k$ 的多重节点，重复节点内部相当于有无穷短的曲线，因此可以在保证整个曲线其他部分连续性的情况下，在重复节点上降低连续性，比如构造出尖锐的转弯

与贝塞尔曲线类似，也可以把 B 样条函数写成一个多项式，并用矩阵表示，从而进一步推广出曲面的画法

## NURBS

在 B 样条中，只能通过改变阶数来改变每个控制点的影响范围，而 NURBS 对每个控制点引入一个额外的权重 $w_i$ ，调整其在范围内的控制能力，并对每个点的总权重进行归一化

$$
\mathbf{S}(t) = \frac{\sum_{i=0}^m N_{i,n}(t) w_i \mathbf{P}_i}{\sum_{i=0}^m N_{i,n}(t) w_i}
$$

NURBS 全名为 非均匀有理 B 样条 Non-Uniform Rational B-Splines 
- 非均匀：节点间隔可以不相等（虽然 B 样条本身就能这样）
- 有理：引入额外权重并归一化，使得曲线可以用有理函数（即两个多项式相除）的形式来表示

B 样条本质上是多项式，所以不能表示圆锥曲线，而 NURBS 的有理性使其能表达圆锥曲线 

![[VCL/img/img2/image-10.png]]









